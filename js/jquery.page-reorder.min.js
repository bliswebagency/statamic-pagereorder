/*!
 * Statamic: Page Reorder
 * https://github.com/jannisg/statamic-pagereorder
 *
 * Build: 0.1.2 (2013-05-29)
 *
 * Copyright (c) 2013 Jannis Gundermann (http://jannisgundermann.com)
 * Released under the MIT license.
 */
/*
 * HTML5 Sortable jQuery Plugin
 * http://farhadi.ir/projects/html5sortable
 *
 * Copyright 2012, Ali Farhadi
 * @license: Released under the MIT license.
 */
!function(a){var b,c=a();a.fn.sortable=function(d){var e=String(d);return d=a.extend({connectWith:!1},d),this.each(function(){if(/^enable|disable|destroy$/.test(e)){var f=a(this).children(a(this).data("items")).attr("draggable","enable"==e);return"destroy"==e&&f.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"),void 0}var g,h,f=a(this).children(d.items),i=a("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');f.find(d.handle).mousedown(function(){g=!0}).mouseup(function(){g=!1}),a(this).data("items",d.items),c=c.add(i),d.connectWith&&a(d.connectWith).add(this).data("connectWith",d.connectWith),f.attr("draggable","true").on("dragstart.h5s",function(c){if(d.handle&&!g)return!1;g=!1;var e=c.originalEvent.dataTransfer;e.effectAllowed="move",e.setData("Text","dummy"),h=(b=a(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){b&&(b.removeClass("sortable-dragging").show(),c.detach(),h!=b.index()&&b.parent().trigger("sortupdate",{item:b}),b=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,i]).on("dragover.h5s dragenter.h5s drop.h5s",function(e){return f.is(b)||d.connectWith===a(b).parent().data("connectWith")?"drop"==e.type?(e.stopPropagation(),c.filter(":visible").after(b),b.trigger("dragend.h5s"),!1):(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",f.is(this)?(d.forcePlaceholderSize&&i.height(b.outerHeight()),b.hide(),a(this)[i.index()<a(this).index()?"after":"before"](i),c.not(i).detach()):c.is(this)||a(this).children(d.items).length||(c.detach(),a(this).append(i)),!1):!0})})}}(jQuery),$(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;return(h="draggable"in document.createElement("span"))?(g={success:_.template('<div id="flash-msg" class="success">\n  <span class="icon">8</span>\n  <span class="msg"><%= message %></p>\n</div>'),error:_.template('<div id="flash-msg" class="error">\n  <span class="icon">c</span>\n  <span class="msg"><%= message %></p>\n</div>')},a=$("#status-bar"),a.on("flash",function(b,c){var d,e,f;return e=50,$("#flash-msg").length&&(e=150,d=$("#flash-msg"),d.stop(!0).fadeOut(e,function(){return d.remove()})),f=g[c.status]({message:c.message}),a.prepend(f),$("#flash-msg").delay(e).animate({"margin-top":"0"},900,"easeOutBounce").delay(3e3).animate({"margin-top":"-74px"},900,"easeInOutBack",function(){return $(this).remove()}),void 0}),d=$("#page-tree"),c=d.find(".subpages"),l="page-order",e=""+l+"-active",j=""+l+"-ignore",f=""+l+"-sortable",i='<div class="'+l+'">\n  <div class="'+l+'__block">\n    <div class="'+l+'__icon">&#11021;</div>\n  </div>\n</div>',d.children().each(function(){var a,b,c;return a=$(this),b=a.find(".page-delete").length,b?(a.addClass(f),null!=(c=a.find("> .page-wrapper"))?c.prepend(i):void 0):a.addClass(j)}),n="",b=null,(k=function(){return b=$("#page-tree").sortable({items:"."+f,handle:"."+l+"__block"})})(),m=function(){return d.html(n),b.sortable("destroy"),k()},b.on({dragstart:function(){return d.addClass(e),c.slideUp({duration:350,easing:"easeInExpo"}),n=d.html()},dragend:function(){return d.removeClass(e),c.slideDown({duration:700,easing:"easeOutExpo"})},sortupdate:function(){var b,c,e,f,g,h;return g=$(this).find("> .page"),c=function(){var a,c,d;for(d=[],a=0,c=g.length;c>a;a++)f=g[a],b=$(f),d.push({index:b.index(),url:$.trim(b.find(".slug-preview").first().text())});return d}(),e=JSON.stringify(c),h="/TRIGGER/pagereorder/reorder",$.ajax(h,{type:"POST",data:{order:e},complete:function(b){var c,e,f,g,h,i,j,k,l;if(b.responseText&&(h=$.parseJSON(b.responseText)),a.triggerHandler("flash",h),"success"===h.status&&null!=h.linkage)for(g=h.linkage,i=0,k=g.length;k>i;i++)if(f=g[i],f.old!==f["new"])for(e=d.find("a[href*='"+f.old+"']"),j=0,l=e.length;l>j;j++)c=e[j],c.href=c.href.replace(""+f.old,""+f["new"]);return"error"===h.status?m():void 0},error:function(){return a.triggerHandler("flash",{status:"error",message:"There was an error saving your page order. Please try again."}),m()}}),void 0}})):!1});